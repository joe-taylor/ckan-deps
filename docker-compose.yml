version: '3'

services:
  postgres:
    build: db
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - 5432:5432

  redis:
    image: redis:6.2-buster
    ports:
      - 6379:6379

  # not strictly a ckan dependency
  keycloak:
    image: jboss/keycloak
    environment:
      - KEYCLOAK_USER
      - KEYCLOAK_PASSWORD
    networks:
      # keycloak gets its own network because postgres'
      # presence in the same network is causing it to crash.
      # Not sure if it's doing service discovery or what, but there's
      # no need for them to share the same network so this is the easiest
      # path forward.
      - keycloak-network
    ports:
      - 9990:8080

  solr:
    build: solr
    ports:
      - 8983:8983
    volumes:
      - solrdata:/opt/solr/server/solr/mycores
    command: ["solr-precreate-ckan", "ckan"]

  # datapusher:
  #   build: datapusher
  #   ports:
  #     - 8800:8800

volumes:
  pgdata:
  solrdata:

networks:
  keycloak-network: